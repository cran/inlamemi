<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>How to avoid using inlamemi</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">How to avoid using inlamemi</h1>



<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(inlamemi)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(INLA)</span></code></pre></div>
<p>In this vignette, we show how to build the measurement error and
missingness models that <code>inlamemi</code> can fit, but without using
<code>inlamemi</code>. This is so that if you have a model that for some
reason does not work within <code>inlamemi</code>, you can see some
examples of how to fit these models “manually”.</p>
<p>There are two ways to structure the data for the models, the first
option is the one taken in <a href="https://arxiv.org/abs/1302.3065">Muff et al (2015)</a> and <a href="https://doi.org/10.1002/bimj.202300078">Skarstein et al
(2023)</a>, where the matrices are constructed directly by hand. The
other approach is the one that is used internally in
<code>inlamemi</code>, where we use the function
<code>inla.stack()</code> to define the data structure for each
sub-model, and then join these together. This latter approach is a bit
more modular, and so this is the approach we will show here.</p>
<div id="a-short-explanation-of-inla.stack-for-hierarchical-modelling" class="section level2">
<h2>A short explanation of <code>inla.stack()</code> for hierarchical
modelling</h2>
<p>The <code>inla.stack()</code> function is most commonly used for
spatial modelling with stochastic partial differential equations (SPDE),
since the data then is a bit more complex to structure. A description of
using stacks in that context can be found in <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-spatial.html#spatial-models-using-stochastic-partial-differential-equations">chapter
7.3.3 of <em>Bayesian inference with INLA</em></a>. However, they can
also be quite useful when defining hierarchical models with multiple
likelihoods, which traditionally need to be defined by setting up
matrices where the structure of the matrices encode the structure of the
model, as explained in <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-INLAfeatures.html#sec:sevlik">chapter
6.4 of <em>Bayesian inference with INLA</em></a>. The stacks are
eventually converted to these matrices by INLA, but for the modeller it
may be more convenient to define the model through the stacks. one
reason is that when setting up the matrices you need to know from the
beginning how many levels you will have in the model, since this
determines the number of columns in the matrices. However, with the
stacks, each model level has its own stack, and previous stacks do not
change if you add additional stacks. That is, the definition of stacks
for each model level can be done independently.</p>
<p>The <code>inla.stack</code> function takes four arguments:</p>
<ul>
<li><code>data</code>: a list of the data on the left side of the
formula (the response)</li>
<li><code>A</code>: a list of projector matrices, in our case for
non-spatial models this is just set to <code>list(1)</code></li>
<li><code>effects</code>: a list of the SPDE index and covariates, in
our case, just a list of a list containing the covariates and random
effects.</li>
<li><code>tag</code>: a character vector labelling this group, which can
be useful for extracting certain parts of the stack later.</li>
</ul>
</div>
<div id="classical-and-berkson-measurement-error-and-missingness" class="section level2">
<h2>Classical and Berkson measurement error and missingness</h2>
<p>In the first example, we use the dataset <code>simple_data</code>,
generated in the vignette <a href="https://emmaskarstein.github.io/inlamemi/articles/simulated_examples.html">Simulated
examples</a>. This dataset has classical and Berkson measurement error,
and missing data, and so the main model we want to fit is</p>
<p><span class="math display">\[
  y_i = \beta_0 + \beta_x x_i + \beta_z z_i + \varepsilon_i,
\]</span> the Berkson measurement error is <span class="math display">\[
  0 = -x_{true, i} + r_i + u_{b,i},
\]</span> the classical measurement error model is <span class="math display">\[
  x_i = r_i + u_{c,i},
\]</span> and the imputation model is</p>
<p><span class="math display">\[
  0 = -r_i + \alpha_0 + \alpha_z z_i + \varepsilon_{r,i}.
\]</span></p>
<p>We begin by loading the data and defining the number of
observations.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>data <span class="ot">&lt;-</span> simple_data</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data)</span></code></pre></div>
<p>Next, we define all the priors and initial values.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Prior for beta.x</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>prior.beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">1000</span>) <span class="co"># N(0, 10^3)</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># Priors for y, measurement error and true x-value precision</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>prior.prec.y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">9</span>)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>prior.prec.u_b <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">9</span>)</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>prior.prec.u_c <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">9</span>)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>prior.prec.r <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">9</span>)</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="co"># Initial values</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>initial.prec.y <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>initial.prec.u_b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>initial.prec.u_c <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>initial.prec.r <span class="ot">&lt;-</span> <span class="dv">1</span></span></code></pre></div>
<p>In <code>inlamemi</code>, we could then fit the model like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>simple_model <span class="ot">&lt;-</span> <span class="fu">fit_inlamemi</span>(<span class="at">data =</span> data,</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>                           <span class="at">formula_moi =</span> y <span class="sc">~</span> x <span class="sc">+</span> z,</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>                           <span class="at">formula_imp =</span> x <span class="sc">~</span> z,</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>                           <span class="at">family_moi =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>                           <span class="at">error_type =</span> <span class="fu">c</span>(<span class="st">&quot;berkson&quot;</span>, <span class="st">&quot;classical&quot;</span>),</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>                           <span class="at">prior.prec.moi =</span> prior.prec.y,</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>                           <span class="at">prior.prec.berkson =</span> prior.prec.u_b,</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>                           <span class="at">prior.prec.classical =</span> prior.prec.u_c,</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>                           <span class="at">prior.prec.imp =</span> prior.prec.r,</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>                           <span class="at">initial.prec.moi =</span> initial.prec.y,</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>                           <span class="at">initial.prec.berkson =</span> initial.prec.u_b,</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>                           <span class="at">initial.prec.classical =</span> initial.prec.u_c,</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>                           <span class="at">initial.prec.imp =</span> initial.prec.r)</span></code></pre></div>
<p>If we instead want to do this without <code>inlamemi</code>, we start
by defining the stacks for each model level.</p>
<p>For the main regression model, we have the model <span class="math display">\[
  y_i = \beta_0 + \beta_x x_i + \beta_z z_i + \varepsilon_i,
\]</span> which is defined in a stack like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>stk_moi <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y_moi =</span> data<span class="sc">$</span>y),</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>),</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>                        <span class="fu">list</span>(<span class="at">beta.0 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n),</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>                             <span class="at">beta.x =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>                             <span class="at">beta.z =</span> data<span class="sc">$</span>z)),</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>                      <span class="at">tag =</span> <span class="st">&quot;moi&quot;</span>)</span></code></pre></div>
<p>Next, the Berkson measurement error model is <span class="math display">\[
  0 = -x_{true, i} + r_i + u_{b,i},
\]</span> and the corresponding stack is:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>stk_b <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y_berkson =</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)),</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>                    <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>),</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>                    <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>                      <span class="fu">list</span>(<span class="at">id.x =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>                           <span class="at">weight.x =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>                           <span class="at">id.r =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>                           <span class="at">weight.r =</span> <span class="dv">1</span>)),</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>                    <span class="at">tag =</span> <span class="st">&quot;berkson&quot;</span>)</span></code></pre></div>
<p>The classical measurement error model is <span class="math display">\[
  x_i = r_i + u_{c,i},
\]</span></p>
<p>and the stack is:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>stk_c <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y_classical =</span> data<span class="sc">$</span>x),</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>                    <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>),</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>                    <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>                      <span class="fu">list</span>(<span class="at">id.r =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>                           <span class="at">weight.r =</span> <span class="dv">1</span>)),</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>                    <span class="at">tag =</span> <span class="st">&quot;classical&quot;</span>)</span></code></pre></div>
<p>Finally, the imputation model is <span class="math display">\[
  0 = -r_i + \alpha_0 + \alpha_z z_i + \varepsilon_{r,i}.
\]</span> and the corresponding stack is</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>stk_imp <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y_imp =</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)),</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>),</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>                        <span class="fu">list</span>(<span class="at">id.r =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>                             <span class="at">weight.r =</span> <span class="fu">rep</span>(<span class="sc">-</span><span class="dv">1</span>, n),</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>                             <span class="at">alpha.0 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n),</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>                             <span class="at">alpha.z =</span> data<span class="sc">$</span>z)),</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>                      <span class="at">tag =</span> <span class="st">&quot;imputation&quot;</span>)</span></code></pre></div>
<p>We then stack these together, which will give us the matrix
formulation that we also could have specified manually.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>stk_full <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(stk_moi, stk_b, stk_c, stk_imp)</span></code></pre></div>
<p>For this model, we have two latent effects, <code>x</code> and
<code>r</code>, which are both specified in the formula. For further
details on the formula, see the supplementary material of <a href="https://doi.org/10.1002/bimj.202300078">Skarstein et al
(2023)</a>, which can be found online here: <a href="https://emmaskarstein.github.io/Missing-data-and-measurement-error/simulation_example.html" class="uri">https://emmaskarstein.github.io/Missing-data-and-measurement-error/simulation_example.html</a></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="fu">list</span>(y_moi, y_berkson, y_classical, y_imp) <span class="sc">~</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">+</span> beta<span class="fl">.0</span> <span class="sc">+</span> beta.z <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="fu">f</span>(beta.x, <span class="at">copy =</span> <span class="st">&quot;id.x&quot;</span>,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>    <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">beta =</span> <span class="fu">list</span>(<span class="at">param =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">1000</span>), <span class="at">fixed =</span> <span class="cn">FALSE</span>))) <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="fu">f</span>(id.x, weight.x, <span class="at">model =</span> <span class="st">&quot;iid&quot;</span>, <span class="at">values =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>    <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="sc">-</span><span class="dv">15</span>, <span class="at">fixed =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="fu">f</span>(id.r, weight.r, <span class="at">model=</span><span class="st">&quot;iid&quot;</span>, <span class="at">values =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>    <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="sc">-</span><span class="dv">15</span>, <span class="at">fixed =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  alpha<span class="fl">.0</span> <span class="sc">+</span> alpha.z</span></code></pre></div>
<p>Finally, we call the <code>inla()</code> function. This model
consists of four Gaussian sub-models, and in the
<code>control.family</code> argument we give the priors for each of
these.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>model_sim <span class="ot">&lt;-</span> <span class="fu">inla</span>(formula, <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk_full),</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">c</span>(<span class="st">&quot;gaussian&quot;</span>, <span class="st">&quot;gaussian&quot;</span>, <span class="st">&quot;gaussian&quot;</span>, <span class="st">&quot;gaussian&quot;</span>),</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>                  <span class="at">control.family =</span> <span class="fu">list</span>(</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="fu">log</span>(initial.prec.y),</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>                                                  <span class="at">param =</span> prior.prec.y,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>                                                  <span class="at">fixed =</span> <span class="cn">FALSE</span>))),</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="fu">log</span>(initial.prec.u_b),</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>                                                  <span class="at">param =</span> prior.prec.u_b,</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>                                                  <span class="at">fixed =</span> <span class="cn">FALSE</span>))),</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="fu">log</span>(initial.prec.u_c),</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>                                                  <span class="at">param =</span> prior.prec.u_c,</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>                                                  <span class="at">fixed =</span> <span class="cn">FALSE</span>))),</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="fu">log</span>(initial.prec.r),</span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>                                                  <span class="at">param =</span> prior.prec.r,</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>                                                  <span class="at">fixed =</span> <span class="cn">FALSE</span>)))</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>                  ),</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>)</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a><span class="fu">summary</span>(model_sim)</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a><span class="co">#&gt; Time used:</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a><span class="co">#&gt;     Pre = 1.87, Running = 2.34, Post = 0.176, Total = 4.38 </span></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a><span class="co">#&gt; Fixed effects:</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a><span class="co">#&gt;          mean    sd 0.025quant 0.5quant 0.975quant  mode kld</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a><span class="co">#&gt; beta.0  1.030 0.219      0.612    1.029      1.435 1.025   0</span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a><span class="co">#&gt; beta.z  1.911 0.388      1.225    1.901      2.560 1.910   0</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a><span class="co">#&gt; alpha.0 1.033 0.051      0.934    1.033      1.132 1.033   0</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a><span class="co">#&gt; alpha.z 2.025 0.052      1.922    2.025      2.127 2.025   0</span></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a><span class="co">#&gt; Random effects:</span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a><span class="co">#&gt;   Name     Model</span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a><span class="co">#&gt;     id.x IID model</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a><span class="co">#&gt;    id.r IID model</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a><span class="co">#&gt;    beta.x Copy</span></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a><span class="co">#&gt; Model hyperparameters:</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a><span class="co">#&gt;                                             mean    sd 0.025quant 0.5quant 0.975quant  mode</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a><span class="co">#&gt; Precision for the Gaussian observations    1.128 0.365      0.556    1.080       1.98 0.992</span></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a><span class="co">#&gt; Precision for the Gaussian observations[2] 1.127 0.355      0.581    1.076       1.96 0.983</span></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a><span class="co">#&gt; Precision for the Gaussian observations[3] 0.927 0.111      0.729    0.920       1.17 0.905</span></span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a><span class="co">#&gt; Precision for the Gaussian observations[4] 0.977 0.128      0.749    0.969       1.25 0.954</span></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a><span class="co">#&gt; Beta for beta.x                            1.972 0.207      1.559    1.974       2.38 1.981</span></span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a><span class="co">#&gt; Marginal log-Likelihood:  -20699.96 </span></span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a><span class="co">#&gt;  is computed </span></span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a><span class="co">#&gt; Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a><span class="co">#&gt; (Posterior marginals needs also &#39;control.compute=list(return.marginals.predictor=TRUE)&#39;)</span></span></code></pre></div>
</div>
<div id="a-model-for-missing-data-missing-not-at-random" class="section level2">
<h2>A model for missing data, missing not at random</h2>
<p>In this example, dealing with only missing data, we show how to
include another level in the model to potentially capture how the
missingness mechanism may depend on available covariates.</p>
<p>In the dataset, simulated below, we let the value of the covariate
<code>x</code> with missingness depend on another covariate
<code>z1</code> (corresponding to the imputation model), while the
probability of an entry in <code>x</code> missing depends on another
covariate <code>z2</code> (corresponding to the missingness model).</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2024</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>z1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>z2 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>alpha<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="dv">1</span>; alpha.z1 <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="at">mean =</span> alpha<span class="fl">.0</span> <span class="sc">+</span> alpha.z1<span class="sc">*</span>z1, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>gamma<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">1.5</span>; gamma.z2 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.5</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>m_pred <span class="ot">&lt;-</span> gamma<span class="fl">.0</span> <span class="sc">+</span> gamma.z2<span class="sc">*</span>z2</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>m_prob <span class="ot">&lt;-</span> <span class="fu">exp</span>(m_pred)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(m_pred))</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">as.logical</span>(<span class="fu">rbinom</span>(n, <span class="dv">1</span>, <span class="at">prob =</span> m_prob))</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>x_obs <span class="ot">&lt;-</span> x</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>x_obs[m] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(x_obs))<span class="sc">/</span><span class="fu">length</span>(x_obs)</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a><span class="co">#&gt; [1] 0.183</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>beta<span class="fl">.0</span> <span class="ot">&lt;-</span> <span class="dv">1</span>; beta.x <span class="ot">&lt;-</span> <span class="dv">2</span>; beta.z1 <span class="ot">&lt;-</span> <span class="dv">2</span>; beta.z2 <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>y <span class="ot">&lt;-</span> beta<span class="fl">.0</span> <span class="sc">+</span> beta.x<span class="sc">*</span>x <span class="sc">+</span> beta.z1<span class="sc">*</span>z1 <span class="sc">+</span> beta.z2<span class="sc">*</span>z2 <span class="sc">+</span> <span class="fu">rnorm</span>(n)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>missing_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">x =</span> x_obs, <span class="at">x_true =</span> x, <span class="at">z1 =</span> z1, <span class="at">z2 =</span> z2)</span></code></pre></div>
<p>The main model of interest is in this case <span class="math display">\[
y_i = \beta_0 + \beta_x x_{true,i} + \beta_{z_1} z_{1,i} + \beta_{z_2}
z_{2,i} + \varepsilon_i ,
\]</span> and the stack is:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>stk_moi <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y_moi =</span> missing_data<span class="sc">$</span>y),</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>),</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>                        <span class="fu">list</span>(<span class="at">beta.0 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n),</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>                             <span class="at">beta.x =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>                             <span class="at">beta.z1 =</span> missing_data<span class="sc">$</span>z1,</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>                             <span class="at">beta.z2 =</span> missing_data<span class="sc">$</span>z2)),</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>                      <span class="at">tag =</span> <span class="st">&quot;moi&quot;</span>)</span></code></pre></div>
<p>The classical measurement error is just functioning as a link in this
case, but the model is <span class="math display">\[
  x_{obs, i} = x_{true, i} + u_{c,i},
\]</span> where the precision of <span class="math inline">\(u_{c,i}\)</span> is set to be very high for those
<span class="math inline">\(i\)</span> where <span class="math inline">\(x_{obs,i}\)</span> is observed. The stack for this
level is:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>stk_c <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y_classical =</span> missing_data<span class="sc">$</span>x),</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>                    <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>),</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>                    <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>                      <span class="fu">list</span>(<span class="at">id.x =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>                           <span class="at">weight.x =</span> <span class="dv">1</span>)),</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>                    <span class="at">tag =</span> <span class="st">&quot;classical&quot;</span>)</span></code></pre></div>
<p>Next we have the imputation model <span class="math display">\[
  0 = -x_{true,i} + \alpha_0 + \alpha_{z_1} z_{1,i} + \varepsilon_{x,i},
\]</span> and the stack is</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>stk_imp <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y_imp =</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)),</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>),</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>                        <span class="fu">list</span>(<span class="at">id.x =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>                             <span class="at">weight.x =</span> <span class="sc">-</span><span class="dv">1</span>,</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>                             <span class="at">alpha.0 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n),</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>                             <span class="at">alpha.z1 =</span> missing_data<span class="sc">$</span>z1)),</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>                      <span class="at">tag =</span> <span class="st">&quot;imputation&quot;</span>)</span></code></pre></div>
<p>The missingness model is a binomial model describing how the
probability of missing, <span class="math inline">\(p_m\)</span>, may
depend on other covariates. The model is <span class="math display">\[
  \text{logit}(p_{m,i}) = \gamma_0 + \gamma_x x_{true,i} + \gamma_{z_2}
z_{2,i},
\]</span> and the stack is:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>stk_mis <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(<span class="at">data =</span> <span class="fu">list</span>(<span class="at">y_mis =</span> <span class="fu">as.numeric</span>(<span class="fu">is.na</span>(missing_data<span class="sc">$</span>x))),</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>                      <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>),</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>                      <span class="at">effects =</span> <span class="fu">list</span>(</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>                        <span class="fu">list</span>(<span class="at">gamma.x =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>                             <span class="at">gamma.0 =</span> <span class="fu">rep</span>(<span class="dv">1</span>, n),</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>                             <span class="at">gamma.z2 =</span> missing_data<span class="sc">$</span>z2)),</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>                      <span class="at">tag =</span> <span class="st">&quot;missingness&quot;</span>)</span></code></pre></div>
<p>We join the stacks together:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>stk_full <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(stk_moi, stk_c, stk_imp, stk_mis)</span></code></pre></div>
<p>In defining the formula, we now need to define the hyperparameter
<code>gamma.x</code>, the same way as we define <code>beta.x</code>.
This is a scaled copy of <code>id.x</code>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>formula <span class="ot">&lt;-</span> <span class="fu">list</span>(y_moi, y_classical, y_imp, y_mis) <span class="sc">~</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>  beta<span class="fl">.0</span> <span class="sc">+</span> beta.z1 <span class="sc">+</span> beta.z2 <span class="sc">+</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  <span class="fu">f</span>(beta.x, <span class="at">copy =</span> <span class="st">&quot;id.x&quot;</span>,</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">beta =</span> <span class="fu">list</span>(<span class="at">param =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">1000</span>), <span class="at">fixed =</span> <span class="cn">FALSE</span>))) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="fu">f</span>(id.x, weight.x, <span class="at">model =</span> <span class="st">&quot;iid&quot;</span>, <span class="at">values =</span> <span class="dv">1</span><span class="sc">:</span>n,</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="sc">-</span><span class="dv">15</span>, <span class="at">fixed =</span> <span class="cn">TRUE</span>))) <span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  <span class="fu">f</span>(gamma.x, <span class="at">copy =</span> <span class="st">&quot;id.x&quot;</span>,</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>    <span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">beta =</span> <span class="fu">list</span>(<span class="at">param =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">1000</span>), <span class="at">fixed =</span> <span class="cn">FALSE</span>))) <span class="sc">+</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>  alpha<span class="fl">.0</span> <span class="sc">+</span> alpha.z1 <span class="sc">+</span> gamma<span class="fl">.0</span> <span class="sc">+</span> gamma.z2</span></code></pre></div>
<p>Since we don’t have any measurement error in this case, we set the
precision to be very high for the classical error model in the argument
<code>scale</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>model_mnar <span class="ot">&lt;-</span> <span class="fu">inla</span>(formula, <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk_full),</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>                  <span class="at">family =</span> <span class="fu">c</span>(<span class="st">&quot;gaussian&quot;</span>, <span class="st">&quot;gaussian&quot;</span>, <span class="st">&quot;gaussian&quot;</span>, <span class="st">&quot;binomial&quot;</span>),</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>                  <span class="at">scale =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, n), <span class="fu">rep</span>(<span class="dv">10</span><span class="sc">^</span><span class="dv">8</span>, n), <span class="fu">rep</span>(<span class="dv">1</span>, n), <span class="fu">rep</span>(<span class="dv">1</span>, n)),</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>                  <span class="at">control.family =</span> <span class="fu">list</span>(</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="fu">log</span>(<span class="dv">1</span>),</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>                                                  <span class="at">param =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">9</span>),</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>                                                  <span class="at">fixed =</span> <span class="cn">FALSE</span>))),</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="fu">log</span>(<span class="dv">1</span>),</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>                                                  <span class="at">param =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">9</span>),</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>                                                  <span class="at">fixed =</span> <span class="cn">FALSE</span>))),</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">hyper =</span> <span class="fu">list</span>(<span class="at">prec =</span> <span class="fu">list</span>(<span class="at">initial =</span> <span class="fu">log</span>(<span class="dv">1</span>),</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>                                                  <span class="at">param =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">9</span>),</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>                                                  <span class="at">fixed =</span> <span class="cn">FALSE</span>))),</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>                    <span class="fu">list</span>()),</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>                  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>, <span class="at">link =</span> <span class="dv">1</span>)</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>)</span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a><span class="fu">summary</span>(model_mnar)</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a><span class="co">#&gt; Time used:</span></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a><span class="co">#&gt;     Pre = 1.9, Running = 3.8, Post = 0.175, Total = 5.88 </span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a><span class="co">#&gt; Fixed effects:</span></span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a><span class="co">#&gt;            mean    sd 0.025quant 0.5quant 0.975quant   mode kld</span></span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a><span class="co">#&gt; beta.0    1.038 0.050      0.940    1.038      1.136  1.038   0</span></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a><span class="co">#&gt; beta.z1   2.004 0.036      1.933    2.004      2.075  2.004   0</span></span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a><span class="co">#&gt; beta.z2   1.985 0.036      1.914    1.985      2.057  1.985   0</span></span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a><span class="co">#&gt; alpha.0   1.011 0.032      0.947    1.011      1.074  1.011   0</span></span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a><span class="co">#&gt; alpha.z1  0.292 0.033      0.228    0.292      0.355  0.292   0</span></span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a><span class="co">#&gt; gamma.0  -1.510 0.122     -1.754   -1.509     -1.275 -1.509   0</span></span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a><span class="co">#&gt; gamma.z2 -0.425 0.088     -0.597   -0.425     -0.252 -0.425   0</span></span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-31"><a href="#cb20-31" tabindex="-1"></a><span class="co">#&gt; Random effects:</span></span>
<span id="cb20-32"><a href="#cb20-32" tabindex="-1"></a><span class="co">#&gt;   Name     Model</span></span>
<span id="cb20-33"><a href="#cb20-33" tabindex="-1"></a><span class="co">#&gt;     id.x IID model</span></span>
<span id="cb20-34"><a href="#cb20-34" tabindex="-1"></a><span class="co">#&gt;    beta.x Copy</span></span>
<span id="cb20-35"><a href="#cb20-35" tabindex="-1"></a><span class="co">#&gt;    gamma.x Copy</span></span>
<span id="cb20-36"><a href="#cb20-36" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-37"><a href="#cb20-37" tabindex="-1"></a><span class="co">#&gt; Model hyperparameters:</span></span>
<span id="cb20-38"><a href="#cb20-38" tabindex="-1"></a><span class="co">#&gt;                                              mean    sd 0.025quant 0.5quant 0.975quant   mode</span></span>
<span id="cb20-39"><a href="#cb20-39" tabindex="-1"></a><span class="co">#&gt; Precision for the Gaussian observations     0.983 0.048      0.890    0.983      1.079  0.984</span></span>
<span id="cb20-40"><a href="#cb20-40" tabindex="-1"></a><span class="co">#&gt; Precision for the Gaussian observations[2]  1.130 0.357      0.590    1.077      1.981  0.977</span></span>
<span id="cb20-41"><a href="#cb20-41" tabindex="-1"></a><span class="co">#&gt; Precision for the Gaussian observations[3]  1.023 0.047      0.932    1.022      1.119  1.020</span></span>
<span id="cb20-42"><a href="#cb20-42" tabindex="-1"></a><span class="co">#&gt; Beta for beta.x                             1.953 0.035      1.884    1.953      2.021  1.955</span></span>
<span id="cb20-43"><a href="#cb20-43" tabindex="-1"></a><span class="co">#&gt; Beta for gamma.x                           -0.036 0.089     -0.213   -0.036      0.138 -0.034</span></span>
<span id="cb20-44"><a href="#cb20-44" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb20-45"><a href="#cb20-45" tabindex="-1"></a><span class="co">#&gt; Marginal log-Likelihood:  -11663.19 </span></span>
<span id="cb20-46"><a href="#cb20-46" tabindex="-1"></a><span class="co">#&gt;  is computed </span></span>
<span id="cb20-47"><a href="#cb20-47" tabindex="-1"></a><span class="co">#&gt; Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span id="cb20-48"><a href="#cb20-48" tabindex="-1"></a><span class="co">#&gt; (Posterior marginals needs also &#39;control.compute=list(return.marginals.predictor=TRUE)&#39;)</span></span></code></pre></div>
<p>Looking at the summary, most importantly, note that the model picks
up <code>gamma.0</code> and <code>gamma.z2</code>, which were defined to
be -1.5 and -0.5, respectively. In the data simulation, we did not
construct the missingness of <code>x</code> to depend on the value of
<code>x</code>, which would correspond to a “missing not at random”
mechanism. The fact that the missingness of <code>x</code> depends on
other observed covariates indicates a “missing at random” mechanism (as
we simulated it to be). If the missingness of <code>x</code> did not
depend on any other covariates, it would be “missing completely at
random”.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
